name: 安全扫描

on:
  pull_request_target:
    paths:
      - 'plugins.v4.json'

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 需要写权限来合并 PR
      pull-requests: write # 需要写权限来评论和合并 PR

    steps:
      - name: Check PR state
        id: pr_state
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber,
            });
            const isOpen = pr.state === 'open';
            core.setOutput('is_open', isOpen ? 'true' : 'false');
            if (!isOpen) {
              console.log(`PR is ${pr.state}; skipping remaining steps.`);
            }

      - name: Check updateTime change
        id: update_time
        if: steps.pr_state.outputs.is_open == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { owner, repo } = context.repo;

            async function getUpdateTime(targetOwner, targetRepo, ref) {
              const { data } = await github.rest.repos.getContent({
                owner: targetOwner,
                repo: targetRepo,
                path: 'plugins.v4.json',
                ref,
              });
              const content = Buffer.from(data.content, data.encoding || 'base64').toString('utf8');
              const json = JSON.parse(content);
              return json.updateTime;
            }

            let mergeBaseSha = pr.merge_base_sha;
            if (!mergeBaseSha) {
              const { data: prData } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: pr.number,
              });
              mergeBaseSha = prData.merge_base_sha;
            }

            if (!mergeBaseSha) {
              try {
                const { data: compare } = await github.rest.repos.compareCommits({
                  owner,
                  repo,
                  base: pr.base.sha || pr.base.ref,
                  head: `${pr.head.repo.owner.login}:${pr.head.ref}`,
                });
                mergeBaseSha = compare.merge_base_commit && compare.merge_base_commit.sha;
              } catch (err) {
                console.log(`compareCommits failed: ${err.message}`);
              }
            }

            if (!mergeBaseSha) {
              console.log('merge_base_sha not found; block auto-merge.');
              core.setOutput('ok', 'false');
              return;
            }

            try {
              const baseTime = await getUpdateTime(
                pr.base.repo.owner.login,
                pr.base.repo.name,
                mergeBaseSha
              );
              const headTime = await getUpdateTime(
                pr.head.repo.owner.login,
                pr.head.repo.name,
                pr.head.sha
              );

              if (baseTime !== headTime) {
                console.log(`updateTime changed (base: ${baseTime || 'missing'}, head: ${headTime || 'missing'}).`);
                core.setOutput('ok', 'false');
                return;
              }
            } catch (err) {
              console.log(`Failed to read plugins.v4.json: ${err.message}`);
              core.setOutput('ok', 'false');
              return;
            }

            core.setOutput('ok', 'true');

      - name: Checkout repository (Base)
        uses: actions/checkout@v4
        if: steps.pr_state.outputs.is_open == 'true' && steps.update_time.outputs.ok == 'true'
        with:
          ref: ${{ github.base_ref }}
          fetch-depth: 0

      - name: Checkout PR plugins.v4.json
        if: steps.pr_state.outputs.is_open == 'true' && steps.update_time.outputs.ok == 'true'
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-${{ github.event.pull_request.number }}
          git checkout pr-${{ github.event.pull_request.number }} -- plugins.v4.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        if: steps.pr_state.outputs.is_open == 'true' && steps.update_time.outputs.ok == 'true'
        with:
          node-version: '20'

      - name: Run Security Scan
        id: scan
        if: steps.pr_state.outputs.is_open == 'true' && steps.update_time.outputs.ok == 'true'
        run: node scripts/security-scan.mjs
        env:
          # 如果需要 GitHub Token 下载资源可以在这里传，目前脚本使用公开链接不需要
          CI: true
          AI_API_BASE: ${{ secrets.AI_API_BASE }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}

      - name: Comment PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request_target' && steps.pr_state.outputs.is_open == 'true' && steps.update_time.outputs.ok == 'true' && failure() == false # 仅在成功时（或需要总是）尝试评论，如果无权限则此步可能失败但 scan 已完成
        continue-on-error: true # 如果因为来自 Fork 导致没权限评论，不要让 CI 挂掉
        with:
          script: |
            const fs = require('fs');
            try {
              const report = fs.readFileSync('security_report.md', 'utf8');
              // 仅当报告包含风险时评论，或者总是评论？
              // 简单起见，总是评论，或者检查内容
              if (report.includes('Risks Found')) {
                 github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: report
                 });
              }
            } catch (e) {
              console.log('No report found or failed to comment', e);
            }

      - name: Recheck PR state
        id: pr_state_final
        if: steps.pr_state.outputs.is_open == 'true' && steps.update_time.outputs.ok == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber,
            });
            const isOpen = pr.state === 'open';
            core.setOutput('is_open', isOpen ? 'true' : 'false');
            if (!isOpen) {
              console.log(`PR is ${pr.state}; skip auto merge.`);
            }

      - name: Auto Merge
        if: steps.pr_state_final.outputs.is_open == 'true' && steps.scan.outputs.has_high_risks == 'false' && github.event_name == 'pull_request_target'
        run: gh pr merge --auto --merge "${{ github.event.pull_request.html_url }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
