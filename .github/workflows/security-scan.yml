name: 安全扫描

on:
  pull_request_target:
    paths:
      - 'plugins.v4.json'

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 需要写权限来合并 PR
      pull-requests: write # 需要写权限来评论和合并 PR

    steps:
      - name: Checkout repository (Base)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          fetch-depth: 0

      - name: Checkout PR plugins.v4.json
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-${{ github.event.pull_request.number }}
          git checkout pr-${{ github.event.pull_request.number }} -- plugins.v4.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Security Scan
        id: scan
        run: node scripts/security-scan.mjs
        env:
          # 如果需要 GitHub Token 下载资源可以在这里传，目前脚本使用公开链接不需要
          CI: true
          AI_API_BASE: ${{ secrets.AI_API_BASE }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}

      - name: Comment PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request_target' && failure() == false # 仅在成功时（或需要总是）尝试评论，如果无权限则此步可能失败但 scan 已完成
        continue-on-error: true # 如果因为来自 Fork 导致没权限评论，不要让 CI 挂掉
        with:
          script: |
            const fs = require('fs');
            try {
              const report = fs.readFileSync('security_report.md', 'utf8');
              // 仅当报告包含风险时评论，或者总是评论？
              // 简单起见，总是评论，或者检查内容
              if (report.includes('Risks Found')) {
                 github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: report
                 });
              }
            } catch (e) {
              console.log('No report found or failed to comment', e);
            }

      - name: Auto Merge
        if: steps.scan.outputs.has_high_risks == 'false' && github.event_name == 'pull_request_target'
        run: gh pr merge --auto --merge "${{ github.event.pull_request.html_url }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
